import random

import tensorflow as tf

import setting
from dataset_worker import dataset_worker
from embedding_worker import embedding_woker

class classifier(tf.keras.Model):
    def __init__(self):
        super(classifier, self).__init__()
        self.model = [
            tf.keras.layers.Dense(64, activation='relu'),
            tf.keras.layers.Dense(1, activation='sigmoid')
        ]

    def call(self, x):
        for layer in self.model:
            x = layer(x)
        return x
    
class classifying_worker():

    def __init__(self) -> None:
        self.c = classifier()
        self.ew = embedding_woker()
        try:
            self.c.load_weights(setting.classifier_path)
            print("Saved classifier weight loaded")
        except:
            print("Saved classifier weight not found")
        self.c.compile(optimizer='adam',
              loss=tf.keras.losses.BinaryCrossentropy(),
              metrics=['accuracy'])

    def train(self, epoch, load_from_raw=False):
        self.c.compile(optimizer='adam',
              loss=tf.keras.losses.BinaryCrossentropy(),
              metrics=['accuracy'])
        
        dsw = dataset_worker(load_from_raw)
        embedding_data = dsw.get_embedding_data()
        non_embedding_data = dsw.get_non_embedding_data()

        embedded_fearure = self.ew.embedding(embedding_data)
        non_embedded_fearure = non_embedding_data[:,:-1]
        feature = tf.concat([embedded_fearure, non_embedded_fearure], 1)
        legitimate_lable = non_embedding_data[:,-1].astype(int)

        full_dataset = tf.data.Dataset.from_tensor_slices((feature, legitimate_lable))
        full_dataset = full_dataset.shuffle(setting.dataset_size, reshuffle_each_iteration=True)
        full_dataset = full_dataset.batch(setting.batch_size)

        train_dataset = full_dataset.take(setting.train_dataset_size)
        test_dataset = full_dataset.skip(setting.train_dataset_size)

        self.c.fit(train_dataset, epochs=epoch, validation_data=test_dataset)
        self.test()
        self.c.save(setting.classifier_path)

    def test(self):
        dsw = dataset_worker()

        indexes = [random.randint(0, setting.dataset_size-1) for _ in range(10)]
        embedding_data = dsw.get_embedding_data()[indexes]
        non_embedding_data = dsw.get_non_embedding_data()[indexes]


        embedded_fearure = self.ew.embedding(embedding_data)
        non_embedded_fearure = non_embedding_data[:,:-1]
        feature = tf.concat([embedded_fearure, non_embedded_fearure], 1)
        legitimate_lable = non_embedding_data[:,-1].astype(int)

        tf.print(self.c.predict(feature))
        tf.print(legitimate_lable)





        