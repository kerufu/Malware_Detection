import time

import tensorflow as tf

import setting
from dataset_worker import dataset_worker
from embedding_worker import embedding_woker

class classifier(tf.keras.Model):
    def __init__(self):
        super(classifier, self).__init__()
        self.model = [
            tf.keras.layers.Dense(64, activation='relu'),
            tf.keras.layers.Dense(1, activation='sigmoid')
        ]

    def call(self, x):
        for layer in self.model:
            x = layer(x)
        return x
    
class classifying_worker():

    def __init__(self) -> None:
        self.c = classifier()
        self.ew = embedding_woker()
        try:
            self.c.load_weights(setting.classifier_path)
        except:
            pass

    def train(self, epoch):
        self.c.compile(optimizer='adam',
              loss=tf.keras.losses.BinaryCrossentropy(),
              metrics=['accuracy'])
        
        dsw = dataset_worker()
        embedding_data = dsw.get_embedding_data()
        non_embedding_data = dsw.get_non_embedding_data()

        embedded_fearure = self.ew.embedding(embedding_data)
        legitimate_lable = non_embedding_data[:,-1].astype(int)

        full_dataset = tf.data.Dataset.from_tensor_slices((embedded_fearure, legitimate_lable))
        full_dataset = full_dataset.shuffle(setting.dataset_size, reshuffle_each_iteration=True)
        full_dataset = full_dataset.batch(setting.batch_size)

        train_dataset = full_dataset.take(setting.train_dataset_size)
        test_dataset = full_dataset.skip(setting.train_dataset_size)

        self.c.fit(train_dataset, epochs=epoch, validation_data=test_dataset)

        self.c.save(setting.classifier_path)




        